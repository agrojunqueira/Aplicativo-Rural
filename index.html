<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />

  <!-- iPhone / PWA friendly -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#111827" />

  <title>Aplicativo Rural — MVP</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden;}

    .app{display:flex;height:100vh;}

    /* ====== SIDEBAR (desktop) ====== */
    .side{
      width:360px; min-width:320px; max-width:420px;
      overflow-y:auto; background:#fff; z-index:2000;
      border-right:1px solid #e5e7eb;
      -webkit-overflow-scrolling: touch;
    }

    .brand{padding:14px 14px 10px;border-bottom:1px solid #e5e7eb;}
    .brand h1{margin:0;font-size:16px;}
    .brand .sub{margin:6px 0 0;color:#6b7280;font-size:12px;line-height:1.3;}

    .controls{padding:10px 14px;border-bottom:1px solid #e5e7eb;}
    select,input,button,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:14px;}
    button{cursor:pointer;background:#111827;color:#fff;border:none;border-radius:10px;}
    button.secondary{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb;}

    .panel{padding:14px;overflow:auto;}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin-bottom:12px;}
    .muted{color:#6b7280;font-size:12px}

    .row{display:flex;gap:10px;}
    .row > *{flex:1;}

    /* ====== MAPA ====== */
    #map{flex:1;height:100vh; min-height: 0;} /* min-height 0 ajuda no iOS */

    /* ====== MODAL ====== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      background:#fff; border-radius:16px; max-width:520px; width:100%;
      max-height:92vh; overflow:auto; border:1px solid #e5e7eb;
    }
    .modal header{padding:14px 16px;border-bottom:1px solid #e5e7eb;}
    .modal main{padding:16px;}
    .modal footer{padding:14px 16px;border-top:1px solid #e5e7eb;display:flex;gap:10px;justify-content:flex-end;}
    label{font-size:12px;color:#374151;font-weight:600;display:block;margin:10px 0 6px;}

    /* ====== BOTÃO + (FAB) ====== */
    #fabAdd{
      display:none;
      position:fixed;
      left:18px; bottom:88px;
      width:64px; height:64px;
      border-radius:999px;
      border:none;
      font-size:34px;
      font-weight:800;
      background:#111827;
      color:#fff;
      z-index:7000;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
    }

    /* ====== MOBILE ====== */
    @media (max-width: 900px){
      body{ overflow:hidden; }

      .app{
        flex-direction:column;
        height:100vh;
      }

      .side{
        width:100%;
        max-width:none;
        min-width:0;
        position:sticky;
        top:0;
        z-index:5000;
        border-right:none;
        border-bottom:1px solid #e5e7eb;
        max-height: 46vh;
        overflow-y:auto;
        -webkit-overflow-scrolling: touch;
      }

      #map{
        flex:1;
        height:auto;
        min-height: 54vh;
      }

      #fabAdd{ display:block; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="side" id="sidebar">
      <div class="brand">
        <h1>Aplicativo Rural — MVP (Mapa + Talhão)</h1>
        <div class="sub">MVP: mapa + seleção por talhão/fazenda + ocorrências (local). Offline/sincronização e relatórios completos entram na próxima fase.</div>
      </div>

      <div class="controls">
        <div class="row" style="margin-bottom:10px;">
          <select id="profileSelect">
            <option value="user">Perfil: Usuário</option>
            <option value="master">Perfil: Master</option>
          </select>
          <select id="modeSelect">
            <option value="talhao">Modo: Talhão</option>
            <option value="fazenda">Modo: Fazenda</option>
          </select>
        </div>

        <select id="farmSelect">
          <option value="">Carregando fazendas…</option>
        </select>
      </div>

      <div class="panel">
        <div class="card" id="infoCard">
          <div class="muted">Selecione uma fazenda e clique em um talhão.</div>
        </div>

        <div class="card">
          <div class="muted"><b>Obs:</b> “COD” aqui usa o identificador único do KML (campo <i>LAYER</i>). Produção 2025 é cruzada por <i>PROPRIEAD_TALHAO</i>.</div>
        </div>
      </div>
    </div>

    <div id="map"></div>
  </div>

  <!-- Botão + flutuante -->
  <button id="fabAdd" title="Criar ocorrência">+</button>

  <!-- Libs do mapa -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@tmcw/togeojson@5.6.2/dist/togeojson.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- SUPABASE (PRECISA vir ANTES do app.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <header>
        <div id="modalTitle" style="font-weight:700;">Nova ocorrência</div>
        <div class="muted" id="modalSub"></div>
      </header>
      <main id="modalBody"></main>
      <footer>
        <button class="secondary" id="modalCancel">Cancelar</button>
        <button id="modalSave">Salvar</button>
      </footer>
    </div>
  </div>

  <!-- Seu app (USAR ./ para não dar ruim em favorito/atalho iOS) -->
  <script src="./app.js"></script>

  <script>
    // (OPCIONAL) Se você tem algum service worker antigo cacheando, isso mata a dor.
    // Se você NÃO usa service worker, pode deixar assim mesmo.
    try{
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs=>{
          regs.forEach(r=>r.unregister());
        });
      }
    }catch(e){}

    // Corrige “mapa branco” no iPhone (atalho/favorito/voltar do background)
    function fixLeafletSize() {
      const m = window.__leafletMap;
      if (m && m.invalidateSize) setTimeout(() => m.invalidateSize(), 250);
    }

    window.addEventListener("load", fixLeafletSize);
    window.addEventListener("resize", fixLeafletSize);
    document.addEventListener("visibilitychange", fixLeafletSize);
    window.addEventListener("pageshow", fixLeafletSize); // importante no iOS
  </script>
</body>
</html>
